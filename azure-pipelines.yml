# =============================================================================
# Azure Pipelines - Task API (Spring Boot 4.0 + Azure SQL Server)
# =============================================================================
# Mejoras incluidas:
# - Cache de Maven para builds m√°s r√°pidos
# - Tests con reportes JUnit y cobertura JaCoCo
# - Stage de Staging antes de Producci√≥n
# - Health checks despu√©s de cada deploy
# - Notificaciones de estado
# - Limpieza de artefactos antiguos
# =============================================================================

trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
  paths:
    exclude:
      - README.md
      - docs/*
      - '*.md'
      - '.gitignore'

pr:
  branches:
    include:
      - main
      - develop

pool:
  name: 'my-agent'

# =============================================================================
# VARIABLES
# =============================================================================
variables:
  # Azure Service Connection
  azureServiceConnection: 'azure-task-api'
  
  # Resource Group
  resourceGroup: 'rg-task-api'
  
  # App Services
  appServiceStaging: 'task-api-emmanuel-staging'
  appServiceProduction: 'task-api-emmanuel'
  
  # URLs para health checks
  stagingUrl: 'https://$(appServiceStaging).azurewebsites.net'
  productionUrl: 'https://$(appServiceProduction).azurewebsites.net'
  
  # Maven
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  
  # Build
  artifactName: 'task-api-artifact'
  
  # Flags
  runTests: 'true'
  deployToStaging: 'true'

# =============================================================================
# STAGES
# =============================================================================
stages:
  # ===========================================================================
  # STAGE 1: BUILD & TEST
  # ===========================================================================
  - stage: Build
    displayName: 'üî® Build & Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Compilar y Probar'
        steps:
          # -------------------------------------------------------------------
          # Checkout
          # -------------------------------------------------------------------
          - checkout: self
            displayName: 'üì• Checkout c√≥digo'
            fetchDepth: '0'

          # -------------------------------------------------------------------
          # Cache de Maven
          # -------------------------------------------------------------------
          - task: Cache@2
            displayName: 'üì¶ Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # -------------------------------------------------------------------
          # Verificar herramientas
          # -------------------------------------------------------------------
          - script: |
              echo "=========================================="
              echo "         VERIFICANDO HERRAMIENTAS         "
              echo "=========================================="
              echo ""
              echo "=== Java Version ==="
              java -version
              echo ""
              echo "=== Maven Version ==="
              mvn -version
              echo ""
              echo "=== Variables de entorno ==="
              echo "JAVA_HOME: $JAVA_HOME"
              echo "Build.SourceBranch: $(Build.SourceBranch)"
              echo "Build.BuildId: $(Build.BuildId)"
            displayName: 'üîç Verificar Java y Maven'

          # -------------------------------------------------------------------
          # Compilar y ejecutar tests
          # -------------------------------------------------------------------
          - task: Maven@4
            displayName: 'üß™ Maven Build & Test'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean verify'
              options: '$(MAVEN_OPTS) -B -Dspring.profiles.active=test'
              javaHomeOption: 'Path'
              jdkDirectory: '$(JAVA_HOME)'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              codeCoverageToolOption: 'JaCoCo'
              codeCoverageClassFilesDirectories: 'target/classes'
              codeCoverageSourceDirectories: 'src/main/java'
            condition: eq(variables['runTests'], 'true')

          # -------------------------------------------------------------------
          # Build sin tests (fallback si tests est√°n deshabilitados)
          # -------------------------------------------------------------------
          - task: Maven@4
            displayName: 'üì¶ Maven Build (sin tests)'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '$(MAVEN_OPTS) -B -DskipTests'
              javaHomeOption: 'Path'
              jdkDirectory: '$(JAVA_HOME)'
            condition: ne(variables['runTests'], 'true')

          # -------------------------------------------------------------------
          # Nota: La cobertura JaCoCo se publica autom√°ticamente por Maven@4
          # con codeCoverageToolOption: 'JaCoCo' (no necesita tarea adicional)
          # -------------------------------------------------------------------

          # -------------------------------------------------------------------
          # Verificar que el JAR se gener√≥
          # -------------------------------------------------------------------
          - script: |
              echo "=== Verificando artefactos generados ==="
              ls -la target/
              echo ""
              echo "=== JAR generado ==="
              ls -la target/*.jar
            displayName: 'üîé Verificar JAR generado'

          # -------------------------------------------------------------------
          # Copiar archivos para deploy
          # -------------------------------------------------------------------
          - task: CopyFiles@2
            displayName: 'üìã Copiar JAR al staging'
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)/target'
              Contents: '*.jar'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          # -------------------------------------------------------------------
          # Copiar archivos de configuraci√≥n adicionales
          # -------------------------------------------------------------------
          - task: CopyFiles@2
            displayName: 'üìã Copiar archivos de configuraci√≥n'
            inputs:
              SourceFolder: '$(System.DefaultWorkingDirectory)'
              Contents: |
                scripts/**
                pom.xml
              TargetFolder: '$(Build.ArtifactStagingDirectory)/config'
            continueOnError: true

          # -------------------------------------------------------------------
          # Publicar artefacto
          # -------------------------------------------------------------------
          - task: PublishBuildArtifacts@1
            displayName: 'üì¶ Publicar Artefacto'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

          # -------------------------------------------------------------------
          # Resumen del build
          # -------------------------------------------------------------------
          - script: |
              echo "=========================================="
              echo "           BUILD COMPLETADO               "
              echo "=========================================="
              echo "Branch: $(Build.SourceBranch)"
              echo "Build ID: $(Build.BuildId)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Artefacto: $(artifactName)"
              echo "=========================================="
            displayName: '‚úÖ Resumen del Build'

  # ===========================================================================
  # STAGE 2: DEPLOY TO STAGING
  # ===========================================================================
  - stage: DeployStaging
    displayName: 'üöÄ Deploy Staging'
    dependsOn: Build
    condition: |
      and(
        succeeded(),
        eq(variables['deployToStaging'], 'true'),
        ne(variables['Build.Reason'], 'PullRequest')
      )
    variables:
      environmentName: 'staging'
    jobs:
      - deployment: DeployToStaging
        displayName: 'Deploy a Staging'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                # Descargar artefacto
                - download: current
                  artifact: $(artifactName)
                  displayName: 'üì• Descargar artefacto'

                # Listar archivos descargados
                - script: |
                    echo "=== Archivos descargados ==="
                    ls -la $(Pipeline.Workspace)/$(artifactName)/
                  displayName: 'üìã Listar artefactos'

                # Deploy a Azure App Service Staging
                - task: AzureWebApp@1
                  displayName: '‚òÅÔ∏è Deploy a App Service Staging'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(appServiceStaging)'
                    package: '$(Pipeline.Workspace)/$(artifactName)/*.jar'
                    runtimeStack: 'JAVA|17-java17'
                    startUpCommand: ''

                # Esperar que la aplicaci√≥n inicie
                - script: |
                    echo "=== Esperando que la aplicaci√≥n inicie (60s) ==="
                    sleep 60
                  displayName: '‚è≥ Esperar inicio de aplicaci√≥n'

                # Health Check
                - script: |
                    echo "=== Health Check Staging ==="
                    echo "URL: $(stagingUrl)/actuator/health"
                    
                    # Intentar health check con reintentos
                    for i in 1 2 3 4 5; do
                      echo "Intento $i de 5..."
                      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $(stagingUrl)/actuator/health || echo "000")
                      
                      if [ "$HTTP_CODE" = "200" ]; then
                        echo "‚úÖ Health check exitoso! HTTP $HTTP_CODE"
                        curl -s $(stagingUrl)/actuator/health | head -100
                        exit 0
                      else
                        echo "‚ö†Ô∏è HTTP $HTTP_CODE - Reintentando en 15s..."
                        sleep 15
                      fi
                    done
                    
                    echo "‚ùå Health check fall√≥ despu√©s de 5 intentos"
                    exit 1
                  displayName: '‚ù§Ô∏è Health Check Staging'
                  continueOnError: 'true'

                # Verificar Swagger
                - script: |
                    echo "=== Verificando Swagger UI ==="
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $(stagingUrl)/swagger-ui.html || echo "000")
                    
                    if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
                      echo "‚úÖ Swagger UI disponible: $(stagingUrl)/swagger-ui.html"
                    else
                      echo "‚ö†Ô∏è Swagger UI retorn√≥ HTTP $HTTP_CODE"
                    fi
                  displayName: 'üìö Verificar Swagger UI'
                  continueOnError: 'true'

  # ===========================================================================
  # STAGE 3: SMOKE TESTS (Opcional)
  # ===========================================================================
  - stage: SmokeTests
    displayName: 'üß™ Smoke Tests'
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - job: RunSmokeTests
        displayName: 'Ejecutar Smoke Tests'
        steps:
          - script: |
              echo "=========================================="
              echo "         EJECUTANDO SMOKE TESTS           "
              echo "=========================================="
              
              API_URL="$(stagingUrl)/api"
              
              # Test 1: Health endpoint
              echo ""
              echo "=== Test 1: Health Check ==="
              curl -s $(stagingUrl)/actuator/health | head -50
              
              # Test 2: GET /api/tasks
              echo ""
              echo "=== Test 2: GET /api/tasks ==="
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $API_URL/tasks)
              if [ "$HTTP_CODE" = "200" ]; then
                echo "‚úÖ GET /api/tasks - HTTP $HTTP_CODE"
              else
                echo "‚ùå GET /api/tasks - HTTP $HTTP_CODE"
              fi
              
              # Test 3: GET /api/tasks/stats
              echo ""
              echo "=== Test 3: GET /api/tasks/stats ==="
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $API_URL/tasks/stats)
              if [ "$HTTP_CODE" = "200" ]; then
                echo "‚úÖ GET /api/tasks/stats - HTTP $HTTP_CODE"
                curl -s $API_URL/tasks/stats | head -20
              else
                echo "‚ùå GET /api/tasks/stats - HTTP $HTTP_CODE"
              fi
              
              # Test 4: POST /api/tasks (crear tarea de prueba)
              echo ""
              echo "=== Test 4: POST /api/tasks ==="
              RESPONSE=$(curl -s -X POST $API_URL/tasks \
                -H "Content-Type: application/json" \
                -d '{"title":"Test Pipeline $(Build.BuildId)","description":"Tarea creada por pipeline","status":"PENDING"}')
              echo "Response: $RESPONSE"
              
              echo ""
              echo "=========================================="
              echo "       SMOKE TESTS COMPLETADOS            "
              echo "=========================================="
            displayName: 'üî• Smoke Tests API'
            continueOnError: 'true'

  # ===========================================================================
  # STAGE 4: DEPLOY TO PRODUCTION
  # ===========================================================================
  - stage: DeployProduction
    displayName: 'üè≠ Deploy Production'
    dependsOn: SmokeTests
    condition: |
      and(
        succeeded(),
        eq(variables['Build.SourceBranch'], 'refs/heads/main')
      )
    variables:
      environmentName: 'production'
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy a Production'
        environment: 'production'  # Requiere aprobaci√≥n manual en Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                # Descargar artefacto
                - download: current
                  artifact: $(artifactName)
                  displayName: 'üì• Descargar artefacto'

                # Deploy a Azure App Service Production
                - task: AzureWebApp@1
                  displayName: '‚òÅÔ∏è Deploy a App Service Production'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(appServiceProduction)'
                    package: '$(Pipeline.Workspace)/$(artifactName)/*.jar'
                    runtimeStack: 'JAVA|17-java17'

                # Esperar inicio
                - script: |
                    echo "=== Esperando que la aplicaci√≥n inicie (90s) ==="
                    sleep 90
                  displayName: '‚è≥ Esperar inicio de aplicaci√≥n'

                # Health Check Production
                - script: |
                    echo "=== Health Check Production ==="
                    
                    for i in 1 2 3 4 5 6; do
                      echo "Intento $i de 6..."
                      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $(productionUrl)/actuator/health || echo "000")
                      
                      if [ "$HTTP_CODE" = "200" ]; then
                        echo "‚úÖ Health check exitoso! HTTP $HTTP_CODE"
                        curl -s $(productionUrl)/actuator/health
                        exit 0
                      else
                        echo "‚ö†Ô∏è HTTP $HTTP_CODE - Reintentando en 20s..."
                        sleep 20
                      fi
                    done
                    
                    echo "‚ùå Health check fall√≥"
                    exit 1
                  displayName: '‚ù§Ô∏è Health Check Production'

                # Resumen final
                - script: |
                    echo "=========================================="
                    echo "     üéâ DEPLOY COMPLETADO EXITOSAMENTE    "
                    echo "=========================================="
                    echo ""
                    echo "üìç URLs de Producci√≥n:"
                    echo "   API:     $(productionUrl)"
                    echo "   Swagger: $(productionUrl)/swagger-ui.html"
                    echo "   Health:  $(productionUrl)/actuator/health"
                    echo ""
                    echo "üìã Informaci√≥n del Build:"
                    echo "   Build ID: $(Build.BuildId)"
                    echo "   Branch:   $(Build.SourceBranch)"
                    echo "   Commit:   $(Build.SourceVersion)"
                    echo "=========================================="
                  displayName: '‚úÖ Resumen Deploy Production'

  # ===========================================================================
  # STAGE 5: CLEANUP (Opcional - Solo en main)
  # ===========================================================================
  - stage: Cleanup
    displayName: 'üßπ Cleanup'
    dependsOn: DeployProduction
    condition: |
      and(
        succeeded(),
        eq(variables['Build.SourceBranch'], 'refs/heads/main')
      )
    jobs:
      - job: CleanupOldArtifacts
        displayName: 'Limpiar recursos antiguos'
        steps:
          - script: |
              echo "=== Limpieza de recursos ==="
              echo "Este stage puede incluir:"
              echo "- Eliminar builds antiguos"
              echo "- Limpiar logs"
              echo "- Purgar cach√©"
              echo ""
              echo "Por ahora, solo mostramos informaci√≥n del deploy completado."
              echo ""
              echo "Build $(Build.BuildId) completado exitosamente."
            displayName: 'üóëÔ∏è Cleanup Info'